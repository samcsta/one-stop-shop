{% extends 'base.html' %}

{% block content %}
<div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
    <h1 class="dashboard-title">Basic Scanner</h1>
    <div>
        <a href="{{ url_for('nuclei_scanner_page') }}" class="btn btn-info">
            <i class="fas fa-radiation mr-2"></i>Nuclei Scanner
        </a>
        <a href="{{ url_for('mainjs_analyzer_page') }}" class="btn btn-warning ml-2">
            <i class="fas fa-code mr-2"></i>Main.js Analyzer
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-5 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-search mr-2 text-primary"></i>Basic Scanner Input</h5>
                <span class="badge badge-success" id="scanner-status">Scanner Ready</span>
            </div>
            <div class="card-body">
                <form id="basic-scan-form" onsubmit="runBasicScan(); return false;">
                    <div class="form-group">
                        <label for="domain-input">Single Domain:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-globe"></i></span>
                            </div>
                            <input type="text" class="form-control" id="domain-input"
                                   placeholder="example.com" value="{{ domain_to_scan }}">
                        </div>
                        <small class="form-text text-muted">Enter one domain (e.g., example.com) OR use the list below.</small>
                    </div>

                    <div class="form-group">
                        <label for="domain-list-input">Domain List (One per line):</label>
                        <textarea class="form-control" id="domain-list-input" rows="5"
                                  placeholder="example.com&#10;sub.example.org&#10;another.net"></textarea>
                        <small class="form-text text-muted">Enter multiple domains here OR use the single input above.</small>
                    </div>
                    <div class="form-group">
                        <h6>Scan Options:</h6>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="check-technologies" checked>
                            <label class="custom-control-label" for="check-technologies">Detect Technologies</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="check-versions" checked>
                            <label class="custom-control-label" for="check-versions">Check Software Versions</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="check-headers" checked>
                            <label class="custom-control-label" for="check-headers">HTTP Headers Analysis</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="check-mainjs" checked>
                            <label class="custom-control-label" for="check-mainjs">Locate main.js Files</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-search mr-2"></i>Scan Domain(s)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-7 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal mr-2 text-primary"></i>Scanner Output</h5>
                <button class="btn btn-sm btn-secondary" onclick="clearTerminal('scan-terminal')">
                    <i class="fas fa-eraser mr-1"></i>Clear Output
                </button>
            </div>
            <div class="card-body">
                <div class="terminal" id="scan-terminal">
                    Basic scanner initialized. Enter a domain or list to begin scanning.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar mr-2 text-primary"></i>Last Scan Results (Summary)</h5>
                <div id="results-header-badge" style="display: none;">
                    <span class="badge badge-primary">Basic Scan</span>
                    <span class="badge ml-2" id="status-badge">Unknown</span>
                </div>
            </div>
            <div class="card-body">
                <div id="results-container" style="display: none;">
                     <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="technologies-tab-display" data-toggle="tab" href="#technologies-display" role="tab"> {/* Changed ID */}
                                <i class="fas fa-code mr-1"></i>Technologies
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="headers-tab-display" data-toggle="tab" href="#headers-display" role="tab"> {/* Changed ID */}
                                <i class="fas fa-exchange-alt mr-1"></i>HTTP Headers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="vulnerabilities-tab-display" data-toggle="tab" href="#vulnerabilities-display" role="tab"> {/* Changed ID */}
                                <i class="fas fa-bug mr-1"></i>Vulnerabilities
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="js-files-tab-display" data-toggle="tab" href="#js-files-display" role="tab"> {/* Changed ID */}
                                <i class="fas fa-file-code mr-1"></i>JavaScript Files
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="resultTabsContent">
                        <div class="tab-pane fade show active" id="technologies-display" role="tabpanel"> {/* Changed ID */}
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">Detected Technologies</h6>
                                    <div id="technologies-list">
                                        <div class="text-muted">No technologies detected</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">Version Information</h6>
                                    <div id="version-info">
                                        <div class="text-muted">No version information available</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="headers-display" role="tabpanel"> {/* Changed ID */}
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">Security Headers</h6>
                                    <div id="security-headers">
                                        <div class="text-muted">No security headers analyzed</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">All HTTP Headers</h6>
                                    <div id="all-headers">
                                        <div class="text-muted">No HTTP headers available</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="vulnerabilities-display" role="tabpanel"> {/* Changed ID */}
                            <div id="vulnerabilities-list">
                                <div class="text-muted">No vulnerabilities detected</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="js-files-display" role="tabpanel"> {/* Changed ID */}
                            <div id="js-files-list">
                                <div class="text-muted">No JavaScript files detected</div>
                            </div>
                            <div id="mainjs-section" class="mt-4" style="display: none;">
                                <div class="alert alert-success">
                                    <h6 class="mb-2"><i class="fas fa-check-circle mr-2"></i>main.js file detected!</h6>
                                    <p class="mb-2" id="mainjs-url"></p>
                                    <div class="mt-2">
                                        <a href="#" id="analyze-mainjs-btn" class="btn btn-sm btn-success">
                                            <i class="fas fa-code mr-1"></i>Analyze in Main.js Analyzer
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="inactive-site-message" style="display: none;">
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle mr-2"></i>Site is inactive</h5>
                        <p>The domain appears to be inactive or inaccessible. No further scanning was performed.</p>
                    </div>
                </div>
                <div id="no-scan-message">
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No scan results yet</h5>
                        <p class="text-muted">Enter a domain or list and click "Scan Domain(s)" to start scanning.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
<script>
// Connect to Socket.IO for real-time updates
const socket = io();
let currentScanGroupId = null; // Track the group ID for multiple scans

// Handle basic scan updates from backend
socket.on('scan_update', function(data) {
    // Display all messages regardless of status or specific scan_id within the group
    let message = `[${data.timestamp.split('T')[1].split('.')[0]}][${data.scan_id}] ${data.message}`; // Simple timestamp + scan ID prefix
    let messageClass = '';

    // Determine class based on status for coloring (optional but helpful)
    switch(data.status) {
        case 'error': messageClass = 'text-danger'; break;
        case 'warning': messageClass = 'text-warning'; break;
        case 'success': messageClass = 'text-success'; break;
        case 'info': messageClass = 'text-info'; break;
        case 'debug': messageClass = 'text-muted small'; break; // Make debug logs less prominent
        case 'critical': messageClass = 'severity-critical'; break;
        case 'high': messageClass = 'severity-high'; break;
        case 'medium': messageClass = 'severity-medium'; break;
        case 'low': messageClass = 'severity-low'; break;
        default: messageClass = '';
    }

    appendToTerminal('scan-terminal', message, messageClass);

    // Update results for the *last* completed scan (simple approach)
    // A more robust approach would track completion per scan_id
    if (data.message.startsWith("Basic scan finished")) {
         document.getElementById('scanner-status').className = 'badge badge-success';
         document.getElementById('scanner-status').innerText = 'Scan(s) Complete';
         // You might want to fetch final results for the *specific* domain ID
         // related to this final message if you need to update the results table.
         // For simplicity, this example doesn't auto-update the results table on completion.
    }
});


// Modified function to handle single or list input
function runBasicScan() {
    const singleDomain = document.getElementById('domain-input').value.trim();
    const domainList = document.getElementById('domain-list-input').value.trim();
    let requestBody = '';
    let domainsToScanCount = 0;

    // Prioritize list if both are filled, or check individually
    if (domainList) {
        requestBody = `domain_list=${encodeURIComponent(domainList)}`;
        domainsToScanCount = domainList.split('\n').filter(d => d.trim()).length;
    } else if (singleDomain) {
        requestBody = `domain=${encodeURIComponent(singleDomain)}`;
        domainsToScanCount = 1;
    } else {
        alert('Please enter a single domain OR a list of domains.');
        return;
    }

    // Update UI to show scanning state
    document.getElementById('scanner-status').className = 'badge badge-warning';
    document.getElementById('scanner-status').innerText = `Scanning ${domainsToScanCount} domain(s)...`;

    // Clear terminal and previous results display
    clearTerminal('scan-terminal');
    resetResultsDisplay(); // Use a separate function to clear the results area

    appendToTerminal('scan-terminal', `Starting basic scan for ${domainsToScanCount} domain(s)...`);

    // Make AJAX request to backend
    fetch('/run-basic-scan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: requestBody // Send either 'domain' or 'domain_list'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            appendToTerminal('scan-terminal', `Error starting scan: ${data.error}`, 'text-danger');
            document.getElementById('scanner-status').className = 'badge badge-danger';
            document.getElementById('scanner-status').innerText = 'Error';
        } else {
            currentScanGroupId = data.scan_group_id; // Store the group ID
            appendToTerminal('scan-terminal', `Scan initiated for ${domainsToScanCount} domain(s). Group ID: ${currentScanGroupId}`, 'text-info');
            // Status will update based on SocketIO messages
        }
    })
    .catch(error => {
        document.getElementById('scanner-status').className = 'badge badge-danger';
        document.getElementById('scanner-status').innerText = 'Request Failed';
        appendToTerminal('scan-terminal', `Error initiating scan request: ${error}`, 'text-danger');
    });
}

// Reset results display area
function resetResultsDisplay() {
    document.getElementById('results-container').style.display = 'none';
    document.getElementById('inactive-site-message').style.display = 'none';
    document.getElementById('no-scan-message').style.display = 'block'; // Show the initial message
    document.getElementById('results-header-badge').style.display = 'none';
    document.getElementById('mainjs-section').style.display = 'none';

    // Clear content within tabs
    document.getElementById('technologies-list').innerHTML = '<div class="text-muted">Scan needed</div>';
    document.getElementById('version-info').innerHTML = '<div class="text-muted">Scan needed</div>';
    document.getElementById('security-headers').innerHTML = '<div class="text-muted">Scan needed</div>';
    document.getElementById('all-headers').innerHTML = '<div class="text-muted">Scan needed</div>';
    document.getElementById('vulnerabilities-list').innerHTML = '<div class="text-muted">Scan needed</div>';
    document.getElementById('js-files-list').innerHTML = '<div class="text-muted">Scan needed</div>';

     // Reset tab badges if they were updated dynamically (optional)
     document.getElementById('vulnerabilities-tab-display').innerHTML = '<i class="fas fa-bug mr-1"></i>Vulnerabilities';
     document.getElementById('js-files-tab-display').innerHTML = '<i class="fas fa-file-code mr-1"></i>JavaScript Files';
}

// --- Terminal Helpers --- (Assumes appendToTerminal and clearTerminal are globally available or defined here/in main.js)
// Using the version from main.js if it's loaded globally, otherwise define locally if needed.
// Make sure these are accessible. If not defined in main.js, define them here:

/*
function appendToTerminal(terminalId, text, className = '') {
    const terminal = document.getElementById(terminalId);
    if (!terminal) return;
    const line = document.createElement('div');
    if (className) {
        line.className = className;
    }
    // Basic HTML check (or use DOMPurify for safety if needed)
    if (text.includes('<') && text.includes('>')) {
         try {
             // Extremely basic check, not foolproof XSS protection
             const temp = document.createElement('div');
             temp.innerHTML = text;
             // Check if it created unexpected elements or scripts
             if (temp.querySelector('script')) {
                  line.textContent = "[HTML content blocked for safety]";
             } else {
                  line.innerHTML = text;
             }
         } catch(e) {
              line.textContent = text; // Fallback to text if HTML parsing fails
         }
    } else {
        line.textContent = text;
    }
    terminal.appendChild(line);
    // Auto-scroll
    terminal.scrollTop = terminal.scrollHeight;
}

function clearTerminal(terminalId) {
    const terminal = document.getElementById(terminalId);
    if (terminal) {
        terminal.innerHTML = '';
    }
}
*/

// Handle auto-run from URL parameter (if needed for basic scanner)
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const autorun = urlParams.get('autorun');
    // Trigger scan if autorun is true and the single domain input has a value
    if (autorun === 'true' && document.getElementById('domain-input').value) {
        setTimeout(runBasicScan, 500); // Delay slightly to ensure UI is ready
    }
});
</script>
{% endblock %}